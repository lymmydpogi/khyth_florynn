{% extends 'ADMIN/base.html.twig' %}

{% block title %}Analytics & Reports{% endblock %}
{% block page_title %}Analytics & Reports{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('style/css/DASHBOARD/analytics.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block body %}
<!-- Page Header -->
<div class="page-header">
    <h1>Business Analytics Dashboard</h1>
    <p>Comprehensive insights into your flower business performance, sales trends, and customer behavior</p>
</div>

<!-- Key Metrics Overview -->
<div class="metrics-overview">
    <div class="metric-card metric-primary">
        <div class="metric-icon">ðŸ’°</div>
        <div class="metric-content">
            <div class="metric-label">Total Revenue</div>
            <div class="metric-value">â‚±{{ monthlyRevenue|number_format(2, '.', ',') }}</div>
            <div class="metric-sublabel">This Month</div>
        </div>
    </div>

    <div class="metric-card metric-warning">
        <div class="metric-icon">ðŸ“¦</div>
        <div class="metric-content">
            <div class="metric-label">Pending Orders</div>
            <div class="metric-value">{{ pendingOrders }}</div>
            <div class="metric-sublabel">Awaiting Processing</div>
        </div>
    </div>

    <div class="metric-card metric-info">
        <div class="metric-icon">ðŸ‘¥</div>
        <div class="metric-content">
            <div class="metric-label">Total Clients</div>
            <div class="metric-value">{{ totalUsers }}</div>
            <div class="metric-sublabel">Registered Customers</div>
        </div>
    </div>

    <div class="metric-card metric-success">
        <div class="metric-icon">ðŸŽ¨</div>
        <div class="metric-content">
            <div class="metric-label">Active Services</div>
            <div class="metric-value">{{ activeServices }}</div>
            <div class="metric-sublabel">Customization Services</div>
        </div>
    </div>
</div>

<!-- Main Charts Section -->
<div class="charts-main-section">
    <!-- Revenue Trend Chart (Full Width) -->
    <div class="chart-container chart-full">
        <div class="chart-header">
            <h3>Revenue Trend (Last 12 Months)</h3>
            <p>Track your monthly revenue performance over time</p>
        </div>
        <div class="chart-body">
            <canvas id="revenueTrendChart"></canvas>
        </div>
    </div>

    <!-- Two Column Charts -->
    <div class="charts-two-column">
        <!-- Orders Status Distribution -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>Orders by Status</h3>
                <p>Distribution of order statuses</p>
            </div>
            <div class="chart-body">
                <canvas id="ordersStatusChart"></canvas>
            </div>
        </div>

        <!-- Payment Methods -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>Payment Methods</h3>
                <p>Preferred payment methods</p>
            </div>
            <div class="chart-body">
                <canvas id="paymentMethodChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Product Categories Performance -->
    <div class="chart-container chart-full">
        <div class="chart-header">
            <h3>Product Categories Performance</h3>
            <p>Sales breakdown by product category</p>
        </div>
        <div class="chart-body">
            <canvas id="productCategoryChart"></canvas>
        </div>
    </div>

    <!-- Three Column Charts -->
    <div class="charts-three-column">
        <!-- Top Services -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>Top Services</h3>
                <p>Most popular customization services</p>
            </div>
            <div class="chart-body">
                <canvas id="topServicesChart"></canvas>
            </div>
        </div>

        <!-- Client Growth -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>Client Growth</h3>
                <p>New clients per month</p>
            </div>
            <div class="chart-body">
                <canvas id="clientGrowthChart"></canvas>
            </div>
        </div>

        <!-- Order Completion Rate -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>Completion Rate</h3>
                <p>Order completion statistics</p>
            </div>
            <div class="chart-body">
                <canvas id="completionRateChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Reports Generation Section -->
<div class="reports-section">
    <div class="section-header">
        <h2>Generate Custom Reports</h2>
        <p>Export detailed reports for your business analysis</p>
    </div>
    
    <form method="GET" action="{{ path('app_analytics_index') }}" class="report-form">
        <div class="form-group">
            <label for="reportType">Report Type</label>
            <select name="reportType" id="reportType" required>
                <option value="">Select Report Type</option>
                <option value="users">Clients Report</option>
                <option value="orders">Orders Report</option>
                <option value="services">Services Report</option>
                <option value="revenue">Revenue Report</option>
                <option value="products">Products Report</option>
            </select>
        </div>

        <div class="form-group">
            <label for="from">From Date</label>
            <input type="date" name="from" id="from">
        </div>

        <div class="form-group">
            <label for="to">To Date</label>
            <input type="date" name="to" id="to">
        </div>

        <div class="form-group form-group-button">
            <button type="submit" class="btn btn-primary">Generate Report</button>
        </div>
    </form>

    <!-- Export Options -->
    {% if report_type is defined and report_type %}
    <div class="export-options">
        <h3>Export Report</h3>
        <div class="export-buttons">
            <a href="{{ path('app_reports_export', {
                format: 'pdf',
                type: report_type,
                from: app.request.get('from'),
                to: app.request.get('to')
            }) }}" class="btn btn-export" target="_blank">
                Export as PDF
            </a>
            <a href="{{ path('app_reports_export', {
                format: 'excel',
                type: report_type,
                from: app.request.get('from'),
                to: app.request.get('to')
            }) }}" class="btn btn-export">
                Export as Excel
            </a>
        </div>
    </div>

    <!-- Report Table -->
    {% if reports_data is defined and reports_data|length > 0 %}
    <div class="report-table-section">
        <h3>{{ report_title }}</h3>
        <div class="table-responsive">
            <table class="report-table">
                <thead>
                    <tr>
                        {% for header in table_headers %}
                        <th>{{ header }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in reports_data %}
                    <tr>
                        {% for cell in row %}
                        <td>{{ cell }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>

<!-- Recent Activity Section -->
<div class="activity-section">
    <div class="section-header">
        <h2>Recent Activity</h2>
        <p>Latest business activities and updates</p>
    </div>
    <div class="activity-list">
        {% for activity in activities %}
        <div class="activity-item">
            <div class="activity-icon activity-{{ activity.type }}">
                {% if activity.type == 'order' %}ðŸ“¦{% else %}ðŸ‘¤{% endif %}
            </div>
            <div class="activity-content">
                <div class="activity-title">{{ activity.title }}</div>
                <div class="activity-time">{{ activity.time|date('M d, Y h:i A') }}</div>
            </div>
        </div>
        {% else %}
        <div class="activity-empty">No recent activity to display.</div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js configuration
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6b7280';
    
    const maroonColors = {
        primary: '#6B0F1A',
        secondary: '#8B1A2A',
        accent: '#A02030',
        light: '#d4a5b0',
        success: '#10b981',
        warning: '#f59e0b',
        danger: '#ef4444',
        info: '#3b82f6'
    };

    // Revenue Trend Chart (Line Chart)
    const revenueCtx = document.getElementById('revenueTrendChart')?.getContext('2d');
    if (revenueCtx) {
        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: {{ monthlyRevenueChartData.labels|json_encode|raw }},
                datasets: [{
                    label: 'Monthly Revenue',
                    data: {{ monthlyRevenueChartData.values|json_encode|raw }},
                    borderColor: maroonColors.primary,
                    backgroundColor: 'rgba(107, 15, 26, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: maroonColors.primary,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        padding: 12,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: function(context) {
                                return 'â‚±' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'â‚±' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Orders by Status Chart (Doughnut)
    const statusCtx = document.getElementById('ordersStatusChart')?.getContext('2d');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: {{ orderStatusData.labels|json_encode|raw }},
                datasets: [{
                    data: {{ orderStatusData.values|json_encode|raw }},
                    backgroundColor: [
                        maroonColors.warning,
                        maroonColors.success,
                        maroonColors.danger
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 13 }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        padding: 10
                    }
                }
            }
        });
    }

    // Payment Method Chart (Pie)
    const paymentCtx = document.getElementById('paymentMethodChart')?.getContext('2d');
    const paymentData = {{ paymentMethodData|default({'labels':[], 'values':[]})|json_encode|raw }};
    if (paymentCtx && paymentData.labels.length > 0) {
        new Chart(paymentCtx, {
            type: 'pie',
            data: {
                labels: paymentData.labels,
                datasets: [{
                    data: paymentData.values,
                    backgroundColor: [
                        maroonColors.primary,
                        maroonColors.secondary,
                        maroonColors.info,
                        maroonColors.success,
                        maroonColors.warning
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 13 }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        padding: 10
                    }
                }
            }
        });
    }

    // Product Category Chart (Bar Chart)
    const categoryCtx = document.getElementById('productCategoryChart')?.getContext('2d');
    const categoryData = {{ productCategoryData|default({'labels':[], 'values':[]})|json_encode|raw }};
    if (categoryCtx && categoryData.labels.length > 0) {
        new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: categoryData.labels,
                datasets: [{
                    label: 'Products',
                    data: categoryData.values,
                    backgroundColor: maroonColors.primary,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        padding: 10
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Top Services Chart (Horizontal Bar)
    const servicesCtx = document.getElementById('topServicesChart')?.getContext('2d');
    if (servicesCtx) {
        new Chart(servicesCtx, {
            type: 'bar',
            data: {
                labels: {{ topServicesData.labels|json_encode|raw }},
                datasets: [{
                    label: 'Orders',
                    data: {{ topServicesData.values|json_encode|raw }},
                    backgroundColor: maroonColors.secondary,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        padding: 10
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Client Growth Chart (Area Chart)
    const growthCtx = document.getElementById('clientGrowthChart')?.getContext('2d');
    if (growthCtx) {
        new Chart(growthCtx, {
            type: 'line',
            data: {
                labels: {{ clientGrowthData.labels|json_encode|raw }},
                datasets: [{
                    label: 'New Clients',
                    data: {{ clientGrowthData.values|json_encode|raw }},
                    borderColor: maroonColors.success,
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: maroonColors.success,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        padding: 10
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Completion Rate Chart (Doughnut)
    const completionCtx = document.getElementById('completionRateChart')?.getContext('2d');
    const completionData = {{ completionRateData|default({'completed': 0, 'pending': 0, 'canceled': 0})|json_encode|raw }};
    if (completionCtx) {
        const total = completionData.completed + completionData.pending + completionData.canceled;
        const completedPercent = total > 0 ? Math.round((completionData.completed / total) * 100) : 0;
        
        new Chart(completionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Pending', 'Canceled'],
                datasets: [{
                    data: [
                        completionData.completed || 0,
                        completionData.pending || 0,
                        completionData.canceled || 0
                    ],
                    backgroundColor: [
                        maroonColors.success,
                        maroonColors.warning,
                        maroonColors.danger
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 13 }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        padding: 10
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
