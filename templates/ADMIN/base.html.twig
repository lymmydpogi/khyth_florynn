<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Welcome!{% endblock %}</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">

    {% block stylesheets %}
        {{ encore_entry_link_tags('app') }}
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="{{ asset('style/css/DASHBOARD/base.css') }}">
        <link rel="stylesheet" href="{{ asset('style/css/DASHBOARD/page-header.css') }}">
        <link rel="stylesheet" href="{{ asset('style/css/DASHBOARD/flash-messages.css') }}">
        <link rel="stylesheet" href="{{ asset('style/css/DASHBOARD/datatables.css') }}">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {% endblock %}

    {% block javascripts %}
        <script>
            // Global Flash Message Handler
            document.addEventListener('DOMContentLoaded', function() {
                {% for label, messages in app.flashes %}
                    {% for message in messages %}
                        Swal.fire({
                            title: '{{ label|capitalize }}',
                            text: '{{ message|e('js') }}',
                            icon: '{{ label == "success" ? "success" : (label == "warning" ? "warning" : (label == "info" ? "info" : "error")) }}',
                            confirmButtonText: 'OK',
                            allowOutsideClick: false,
                            customClass: {
                                popup: 'florynn-swal-popup',
                                title: 'florynn-swal-title',
                                content: 'florynn-swal-content',
                                confirmButton: 'florynn-swal-confirm'
                            }
                        });
                    {% endfor %}
                {% endfor %}
            });
        </script>
    {% endblock %}
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">

        <!-- Logo Section -->
        <div class="sidebar-logo">
            <img src="{{ asset('images/florynn.png') }}" alt="Florynn Logo" class="logo-img">
        </div>

        <h2 class="sidebar-title">
            {% if 'ROLE_ADMIN' in app.user.roles %}
                ADMIN PANEL
            {% elseif 'ROLE_STAFF' in app.user.roles %}
                STAFF PANEL
            {% else %}
                USER PANEL
            {% endif %}
        </h2>

        <!-- Navigation -->
        <nav class="sidebar-nav">
            {% if 'ROLE_ADMIN' in app.user.roles %}
                {% set navItems = [
                    { path: 'app_home_index', label: 'Dashboard', icon: '' },
                    { path: 'app_products_index', label: 'Products', icon: '' },
                    { path: 'app_services_index', label: 'Services', icon: '' },
                    { path: 'app_order_index', label: 'Orders', icon: '' },
                    { path: 'app_user_index', label: 'Users', icon: '' },
                    { path: 'app_analytics_index', label: 'Analytics', icon: '' },
                    { path: 'admin_activity_logs_index', label: 'Activity Logs', icon: '' },
                ] %}
            {% elseif 'ROLE_STAFF' in app.user.roles %}
                {% set navItems = [
                    { path: 'app_staff_dashboard_index', label: 'Dashboard', icon: '' },
                    { path: 'app_products_index', label: 'Products', icon: '' },
                    { path: 'app_services_index', label: 'Services', icon: '' },
                    { path: 'app_order_index', label: 'Orders', icon: '' },
                ] %}
            {% endif %}

            {% for item in navItems %}
                {% set isActive = app.request.attributes.get('_route') starts with item.path %}
                
                <a href="{{ path(item.path) }}"
                   class="nav-link {{ isActive ? 'active' : '' }}">
                    <span class="nav-indicator"></span>
                    <span class="nav-icon">{{ item.icon }}</span>
                    <span class="nav-label">{{ item.label }}</span>
                </a>
            {% endfor %}
        </nav>

        <!-- Logout Button at Bottom -->
        <div class="sidebar-logout">
            <a href="{{ path('app_logout') }}" class="logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span>Logout</span>
            </a>
        </div>

    </div>

    <!-- Top Navbar -->
    <nav class="top-navbar">
        <div class="navbar-title">
            {% block page_title %}Dashboard{% endblock %}
        </div>
        <div class="navbar-actions">
            <!-- Profile Section -->
            <div class="navbar-profile">
                <a href="{{ path('app_profile') }}" class="profile-link">
                    <div class="profile-avatar">
                        {% if app.user.avatar %}
                            <img src="{{ asset('uploads/avatars/' ~ app.user.avatar) }}" 
                                 alt="{{ app.user.name ?? 'User' }}" 
                                 class="avatar-img"
                                 onerror="this.onerror=null; this.style.display='none';">
                        {% else %}
                            <!-- No avatar in database, showing initials -->
                            <div class="avatar-initials">
                                {{ app.user.name ? app.user.name|slice(0, 2)|upper : app.user.email|slice(0, 2)|upper }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="profile-info">
                        <p class="profile-name">{{ app.user.name ?? app.user.email|split('@')[0]|title }}</p>
                        <p class="profile-role">
                            {% if 'ROLE_ADMIN' in app.user.roles %}
                                Administrator
                            {% elseif 'ROLE_STAFF' in app.user.roles %}
                                Staff
                            {% else %}
                                Client
                            {% endif %}
                        </p>
                    </div>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="content-container">
            {% block body %}{% endblock %}
        </div>
    </div>

    <!-- Mobile menu button -->
    <button type="button" class="mobile-menu-btn" id="mobile-menu-button">
        <svg xmlns="http://www.w3.org/2000/svg" class="menu-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
        </svg>
    </button>

    {# Access Denied Modal #}
    {% if app.request.query.get('access_denied') == '1' %}
        {% set message = app.session.get('_security.access_denied_message') %}
        {% if message %}
            {% do app.session.remove('_security.access_denied_message') %}
            
            <div class="modal show" id="accessDeniedModal" style="display: block;">
                <div class="modal-backdrop" onclick="document.getElementById('accessDeniedModal').remove()"></div>
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Access Denied</h5>
                        </div>
                        <div class="modal-body">
                            <p>{{ message }}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('accessDeniedModal').remove()">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                .modal.show {
                    display: block;
                    position: fixed;
                    z-index: 1050;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    overflow: hidden;
                }
                
                .modal-backdrop {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background-color: rgba(0, 0, 0, 0.5);
                    z-index: 1040;
                    cursor: pointer;
                }
                
                .modal-dialog {
                    position: relative;
                    margin: 1.75rem auto;
                    max-width: 500px;
                    z-index: 1050;
                }
                
                .modal-content {
                    position: relative;
                    background-color: white;
                    border-radius: 0.3rem;
                    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5);
                }
                
                .modal-header, .modal-body, .modal-footer {
                    padding: 1rem;
                }
                
                .modal-header {
                    border-bottom: 1px solid #dee2e6;
                }
                
                .modal-footer {
                    border-top: 1px solid #dee2e6;
                    text-align: right;
                }
                
                .btn {
                    padding: 0.375rem 0.75rem;
                    border-radius: 0.25rem;
                    border: 1px solid transparent;
                    cursor: pointer;
                }
                
                .btn-secondary {
                    background-color: #6c757d;
                    color: white;
                }
                
                .btn-secondary:hover {
                    background-color: #5a6268;
                }
            </style>
        {% endif %}
    {% endif %}

    <script>
        // Mobile menu toggle
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('mobile-open');
        });

        // Ensure active link highlighting works properly
        document.addEventListener('DOMContentLoaded', function() {
            const currentRoute = "{{ app.request.attributes.get('_route') }}";
            const navLinks = document.querySelectorAll('.nav-link');

            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && currentRoute && href.includes(currentRoute)) {
                    link.classList.add('active');
                }
            });
        });

        // Profile actions are handled via links, no JS needed

        // Apply dark mode on every page load
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('adminDarkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
        });
    </script>

</body>
</html>